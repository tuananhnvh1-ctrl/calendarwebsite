<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Lịch Google Của Tôi</title>
    <style>
      body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
      #authorize_button, #signout_button { display: none; padding: 10px 20px; cursor: pointer; margin-bottom: 20px;}
      #content { white-space: pre-wrap; background: #f4f4f4; padding: 15px; border-radius: 5px; }
      .event-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
      .event-time { font-weight: bold; color: #555; }
      .event-summary { color: #007bff; font-size: 1.1em; }
    </style>
  </head>
  <body>
    <h1>Lịch Google Calendar</h1>

    <button id="authorize_button" onclick="handleAuthClick()">Đăng nhập Google</button>
    <button id="signout_button" onclick="handleSignoutClick()">Đăng xuất</button>

    <div id="content"></div>

    <script type="text/javascript">
      /* ---------------- CẤU HÌNH TẠI ĐÂY ---------------- */
      const CLIENT_ID = '136787386260-ldeappr40bs6n747fc88q4sork2240mr.apps.googleusercontent.com'; // Thay bằng Client ID của bạn
      const API_KEY = 'AIzaSyCcP60Qm19GvD7WUJzyeT4fm78SSCxR_H4';     // Thay bằng API Key của bạn
      /* ---------------------------------------------------- */

      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
      const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById('content').innerText = 'Đang tải thư viện...';

      function gapiLoaded() {
        gapi.load('client', intializeGapiClient);
      }

      async function intializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // Sẽ được định nghĩa khi nhấn nút
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('content').innerText = 'Hãy đăng nhập để xem lịch.';
          document.getElementById('authorize_button').style.display = 'block';
        }
      }

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.display = 'block';
          document.getElementById('authorize_button').style.display = 'none';
          await listUpcomingEvents();
        };

        if (gapi.client.getToken() === null) {
          // Yêu cầu quyền truy cập lần đầu
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          // Bỏ qua prompt nếu đã có token
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content').innerText = 'Đã đăng xuất.';
          document.getElementById('authorize_button').style.display = 'block';
          document.getElementById('signout_button').style.display = 'none';
        }
      }

      async function listUpcomingEvents() {
        document.getElementById('content').innerHTML = 'Đang tải dữ liệu lịch...';
        
        try {
          const request = {
            'calendarId': 'primary', // 'primary' là lịch chính của người đăng nhập
            'timeMin': (new Date()).toISOString(), // Lấy từ thời điểm hiện tại
            'showDeleted': false,
            'singleEvents': true,
            'maxResults': 20, // Số lượng sự kiện muốn lấy
            'orderBy': 'startTime',
          };
          
          const response = await gapi.client.calendar.events.list(request);
          const events = response.result.items;

          if (!events || events.length === 0) {
            document.getElementById('content').innerText = 'Không tìm thấy sự kiện nào sắp tới.';
            return;
          }

          let output = '';
          events.forEach((event) => {
            let when = event.start.dateTime;
            if (!when) {
              when = event.start.date + " (Cả ngày)";
            } else {
                when = new Date(when).toLocaleString('vi-VN');
            }
            
            output += `
              <div class="event-item">
                <div class="event-time">${when}</div>
                <div class="event-summary">${event.summary}</div>
                <div>${event.description || ''}</div>
              </div>
            `;
          });
          document.getElementById('content').innerHTML = output;
        } catch (err) {
          document.getElementById('content').innerText = 'Lỗi: ' + err.message;
        }
      }
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>